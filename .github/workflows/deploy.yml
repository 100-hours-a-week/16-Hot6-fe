name: Frontend CI & dev CD

on:
  push:
    branches:
      - prod-temp

jobs:
  build-and-deploy:
    name: Build and Deploy to S3
    runs-on: ubuntu-latest
    environment: ${{ github.ref_name == 'main' && 'main' || 'dev' }} #임시로그냥 dev사용

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          path: .

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm install --legacy-peer-deps
        working-directory: ott

      - name: Build React app
        run: npm run build
        working-directory: ott

      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          credentials_json: '${{ secrets.GCP_SA_KEY }}'
      
      - name: Generate secrets.properties from GCP Secrets
        run: |
          mkdir -p ./secrets
          touch ./secrets/secrets.properties

          for LABEL in $SECRET_LABELS; do
            gcloud secrets list --filter="labels.env=$LABEL" --format="value(name)" | while read SECRET_NAME; do
              SECRET_VALUE=$(gcloud secrets versions access latest --secret="$SECRET_NAME")
              IFS='-' read -r SERVICE KEY ENV <<< "$SECRET_NAME"
              echo "${KEY}=${SECRET_VALUE}" >> ./secrets/secrets.properties
            done
          done
        env:
          SECRET_LABELS: "backend_shared"
      

      - name: Configure AWS credentials from secrets.properties
        run: |
          source ./secrets/secrets.properties
          aws configure set aws_access_key_id "$S3_ACCESS_KEY"
          aws configure set aws_secret_access_key "$S3_SECRET_KEY"
          aws configure set region ap-northeast-2

      - name: Deploy to S3
        run: |
          aws s3 sync ott/dist/ s3://onthe-top/frontend/prod/blue \
            --delete \
            --acl public-read
